crypto isakmp policy 200
  encryption aes 128
  authentication pre-share
  group 2
  lifetime 28800
  hash sha
exit

crypto keyring {{ cloud_network_interconnect_name }}-keyring-0
  local-address {{ cloud_network_interconnect_external_interface }}
  pre-shared-key address {{ '{{' }} cloud_network_interconnect_peer_a_public_ip {{ '}}' }} key {{ cloud_network_interconnect_psk }}
exit

crypto isakmp profile {{ cloud_network_interconnect_name }}-isakmp-0
  local-address {{ cloud_network_interconnect_external_interface }}
  match identity address {{ '{{' }} cloud_network_interconnect_peer_a_public_ip {{ '}}' }}
  keyring {{ cloud_network_interconnect_name }}-keyring-0
exit

crypto ipsec transform-set {{ cloud_network_interconnect_name }}-ipsec-transform-set-0 esp-aes 128 esp-sha-hmac
  mode tunnel
exit

crypto ipsec profile {{ cloud_network_interconnect_name }}-ipsec-profile-0
  set pfs group2
  set security-association lifetime seconds 3600
  set transform-set {{ cloud_network_interconnect_name }}-ipsec-transform-set-0
exit

crypto ipsec df-bit clear

crypto isakmp keepalive 10 10 on-demand

crypto ipsec security-association replay window-size 128

crypto ipsec fragmentation before-encryption

interface Tunnel1
  ip address 169.254.58.50 255.255.255.252
  ip virtual-reassembly
  tunnel source {{ cloud_network_interconnect_external_interface }}
  tunnel destination {{ '{{' }} cloud_network_interconnect_peer_a_public_ip {{ '}}' }}
  tunnel mode ipsec ipv4
  tunnel protection ipsec profile {{ cloud_network_interconnect_name }}-ipsec-profile-0
  ! This option causes the router to reduce the Maximum Segment Size of
  ! TCP packets to prevent packet fragmentation.
  ip tcp adjust-mss 1379
  no shutdown
exit

ip sla 100
   icmp-echo 169.254.58.49 source-interface Tunnel1
   timeout 5000
   frequency 5
exit
ip sla schedule 100  life forever start-time now
track 100 ip sla 100 reachability
